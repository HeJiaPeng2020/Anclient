(()=>{"use strict";var e={200:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AnboxException=void 0;class n extends Error{constructor(e){super(e),this.name="AnboxException"}getMessage(){return this.message||this.name}}t.AnboxException=n},938:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.pythonCmd=t.isLittleEndian=t.OS=t.translationsConfigFile=t.locale=t.language=t.userAgent=t.platform=t.isIOS=t.isWeb=t.isNative=t.isLinuxSnap=t.isLinux=t.isMacintosh=t.isWindows=t.platformToString=t.isElectronSandboxed=t.globals=void 0;const i=n(17),s="en";let o,r,a,l,c=!1,h=!1,d=!1,p=!1,w=!1,v=!1,u=!1,g=s;t.globals="object"==typeof self?self:"object"==typeof global?global:{},void 0!==t.globals.vscode&&void 0!==t.globals.vscode.process?l=t.globals.vscode.process:"undefined"!=typeof process&&(l=process);const b="string"==typeof l?.versions?.electron&&"renderer"===l.type;if(t.isElectronSandboxed=b&&l?.sandboxed,"object"!=typeof navigator||b)if("object"==typeof l){c="win32"===l.platform,h="darwin"===l.platform,d="linux"===l.platform,p=d&&!!l.env.SNAP&&!!l.env.SNAP_REVISION,o=s,g=s;const e=l.env.VSCODE_NLS_CONFIG;if(e)try{const t=JSON.parse(e),n=t.availableLanguages["*"];o=t.locale,g=n||s,r=t._translationsConfigFile}catch(e){}w=!0}else console.error("Unable to resolve platform.");else a=navigator.userAgent,c=a.indexOf("Windows")>=0,h=a.indexOf("Macintosh")>=0,u=(a.indexOf("Macintosh")>=0||a.indexOf("iPad")>=0||a.indexOf("iPhone")>=0)&&!!navigator.maxTouchPoints&&navigator.maxTouchPoints>0,d=a.indexOf("Linux")>=0,v=!0,o=navigator.language,g=o;t.platformToString=function(e){switch(e){case 0:return"Web";case 1:return"Mac";case 2:return"Linux";case 3:return"Windows"}};let m=0;h?m=1:c?m=3:d&&(m=2),t.isWindows=c,t.isMacintosh=h,t.isLinux=d,t.isLinuxSnap=p,t.isNative=w,t.isWeb=v,t.isIOS=u,t.platform=m,t.userAgent=a,t.language=g,t.locale=o,t.translationsConfigFile=r,t.OS=h||u?2:c?1:3;let f=!0,x=!1;t.isLittleEndian=function(){if(!x){x=!0;const e=new Uint8Array(2);e[0]=1,e[1]=2;const t=new Uint16Array(e.buffer);f=513===t[0]}return f},t.pythonCmd=function(e){let n="python3";return 1===t.OS&&(n="py"),i.join(e,n)}},624:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ServHelper=void 0;const i=n(17),s=n(496),o=n(200);function r(e){const t=e.fsPath;let n=s.workspace.workspaceFolders;if(!n)throw new o.AnboxException("Why workspaceFolder is null?");return n.map((e=>e.uri.fsPath)).filter((e=>t?.startsWith(e)))[0]}t.ServHelper=class{constructor(e,t){this.serv=Object.assign({pythonPath:e.asAbsolutePath(i.join("packages","anserv.py")),starting:!1,webpackTerm:void 0},t),this.context=e}isStarting(){return this.serv.starting}starting(e){return this.serv.starting=e,this}pythonPath(){return this.serv.pythonPath}webroot(e){const t=s.workspace.getConfiguration("launch",e)?.get("configurations");if(t)for(let n=0;n<t.length;n++)if(console.log(t[n]),"pwa-chrome"===t[n].type){this.serv.webroot=this.resolvEnv(t[n].webRoot,{workspaceFolder:r(e)});break}return this}resolvEnv(e,t){return e.replace(/\${workspaceFolder}/g,t.workspaceFolder)}webrootPath(){return this.serv.webroot||"."}url(e){let t=i.relative(this.webrootPath(),e.html.fsPath);return`http://${e.host}:${e.port}/${t}`}checkHtml(e){if(this.serv.webroot){if(!e.fsPath?.startsWith(this.serv.webroot))throw new o.AnboxException("page is not located in root folder: "+e.fsPath)}else this.webroot(e);return this}}},496:e=>{e.exports=require("vscode")},81:e=>{e.exports=require("child_process")},17:e=>{e.exports=require("path")}},t={};function n(i){var s=t[i];if(void 0!==s)return s.exports;var o=t[i]={exports:{}};return e[i](o,o.exports,n),o.exports}var i={};(()=>{var e=i;Object.defineProperty(e,"__esModule",{value:!0}),e.deactivate=e.activate=void 0;const t=n(496),s=n(81),o=n(17),r=n(938),a=n(624),l=n(200);e.activate=function(e){c.log||(c.log=t.window.createOutputChannel("Anbox")),c.log.appendLine("Starting Anbox ..."),e.subscriptions.push(t.commands.registerCommand("anbox.load",((t,n)=>{c.init(e,t),c.currentPanel?.load(e,t)}))),e.subscriptions.push(t.commands.registerCommand("anbox.refresh",(()=>{c.currentPanel&&c.currentPanel.refresh(void 0)}))),e.subscriptions.push(t.commands.registerCommand("anbox.restartServer",(()=>{c.currentPanel?c.currentPanel.startup():t.window.showInformationMessage("Sever only started when Anbox is loaded!")}))),e.subscriptions.push(t.commands.registerCommand("anbox.shutdownServer",(()=>{c.currentPanel&&(c.currentPanel.serv.starting(!1),c.currentPanel.close())}))),t.window.registerWebviewPanelSerializer&&t.window.registerWebviewPanelSerializer(c.viewType,{async deserializeWebviewPanel(t,n){console.log(`Got state: ${n}`),t.webview.options=(e.extensionUri,{enableScripts:!0}),c.revive(e,t,void 0)}})},e.deactivate=function(){c.currentPanel&&c.currentPanel.close()};class c{constructor(e,n,i){this._disposables=[],this.page={port:"8888",host:"localhost",html:t.Uri.file("index.html"),style:"background-color: #ccc"},this.serv=i,this._panel=n,this._extensionUri=e.extensionUri,this.loadOnline(),this._panel.onDidDispose((()=>this.dispose()),null,this._disposables),this._panel.onDidChangeViewState((e=>{this._panel.visible&&this.refresh(void 0)}),null,this._disposables),this._panel.webview.onDidReceiveMessage((e=>{"alert"!==e.command||t.window.showErrorMessage(e.text)}),null,this._disposables)}static init(e,n){if(c.currentPanel)return c.currentPanel;if(!n){let e=t.window.activeTextEditor?.document.uri;e?.fsPath&&new Set([".html",".htm"]).has(o.extname(e?.fsPath))&&(n=t.window.activeTextEditor?.document.uri)}if(n){let i=new a.ServHelper(e).checkHtml(n);c.log.appendLine("web root: "+i.webrootPath());const s=t.window.createWebviewPanel(c.viewType,"Anbox",t.window.activeTextEditor?.viewColumn||t.ViewColumn.One,{retainContextWhenHidden:!1});return s.webview.options=(e.extensionUri,{enableScripts:!0}),c.revive(e,s,i)}t.window.showInformationMessage("Anbox don't know which html page to load!")}static revive(e,t,n){n=n||new a.ServHelper(e);const i=new c(e,t,n);return i._panel.webview.onDidReceiveMessage((e=>i.handleWebviewMessage(e))),c.currentPanel=i,c.log.appendLine("Anbox webview revived."),c.currentPanel}handleWebviewMessage(e){"devtools-open"!==e.command||t.commands.executeCommand("workbench.action.webview.openDeveloperTools")}async load(e,n){if(!this.serv.isStarting())try{await c.currentPanel.startup()}catch(e){t.window.showInformationMessage(e.getMessage()||"")}const i=t.window.activeTextEditor?t.window.activeTextEditor.viewColumn:void 0;if(!c.currentPanel){const s=t.window.createWebviewPanel(c.viewType,`Anbox - ${c.filename(n)}`,i||t.ViewColumn.One);c.log.append("Open page "+c.filename(n)),c.currentPanel=new c(e,s,this.serv)}try{this.refresh(n)}catch(e){e instanceof l.AnboxException&&t.window.showErrorMessage(e.getMessage())}c.currentPanel._panel.reveal(i)}async startup(){const e=`${(0,r.pythonCmd)("")} ${this.serv.pythonPath()} -b 0.0.0.0 -w ${this.serv.webrootPath()} ${this.page.port} &`;this.serv.starting(!0),c.log.appendLine(e),t.window.showInformationMessage("Starting Anbox server at "+this.serv.webrootPath()),new Promise(((n,i)=>{s.exec(e,((e,s)=>e?(this.serv.starting(!1),c.log.appendLine(e.message),t.window.showInformationMessage("Starting Anbox server failed. "+e.message),i(e)):(this.serv.starting(!1),c.log.appendLine(s.toString()),n(s))))}))}dispose(){for(c.currentPanel=void 0,this._panel.dispose();this._disposables.length;){const e=this._disposables.pop();e&&e.dispose()}}loadOnline(){this._panel.webview,this._panel.webview.html=this.getAnclientPage(this.page)}refresh(e){this._panel.webview.html="",this.page.html=e||this.page.html,this.serv.checkHtml(this.page.html),this._panel.webview.html=this.getAnclientPage(this.page)}getAnclientPage(e){let t=this.serv.url(e);return`<!DOCTYPE html>\n\t\t<html lang="en">\n\t\t<head>\n\t\t\t<meta charset="UTF-8">\n\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t\t\t<script type="text/javascript">var vscode = acquireVsCodeApi();</script\n\t\t</head>\n\t\t<body>\n\t\t\t<p id="lines-of-code-counter">${t}\n\t\t\t<input type='button' value='refresh' onclick='console.log("refresh"); document.getElementById("i-anbox").src = document.getElementById("i-anbox").src'\n\t\t\t/>\n\t\t\t<input type='button' value='dev tool'\n\t\t\t\tonclick='vscode.postMessage({ command: "devtools-open", text: "" });'\n\t\t\t/>\n\t\t\t</p>\n\t\t\t<iframe id='i-anbox' src="${t}" width="100%" height="720px" style="${e.style}" ></iframe>\n\t\t</body>\n\t\t</html>`}close(){c.log.appendLine("Shuting down: "+this.serv?.serv.webroot),t.window.showInformationMessage("Shuting down Anbox server. "+this.page.html),this.page.html=t.Uri.file("?_shut-down_=True");let e=this.serv.url(this.page);console.log(e),this._panel.webview.html="",this._panel.webview.html=`<!DOCTYPE html>\n\t\t<html lang="en">\n\t\t<head>\n\t\t\t<meta charset="UTF-8">\n\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t\t</head>\n\t\t<body>\n\t\t\t<iframe src="${e}" width="100%" height="720px" style="${this.page.style}" ></iframe>\n\t\t</body>\n\t\t</html>`}static filename(e){return o.basename(e.path)}}c.viewType="anbox"})(),module.exports=i})();
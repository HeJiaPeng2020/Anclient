<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<title>JClient/EasyUI Demo</title>

	<script src="http://www.jeasyui.com/easyui/jquery.easyui.min.js"></script>

	<script src="../jclient/jeasy-api.js" type="text/javascript" charset="utf-8"></script>
	<script src="../jclient/jeasy-html.js" type="text/javascript" charset="utf-8"></script>

	<style type="text/css">
	</style>
</head>

<body class="easyui-layout">
	<div data-options="region:'north',border:false" style="height: 60px; padding: 0px">
		<div id="topmenu" class="l-topmenu">
			<div class="l-topmenu-logo">JClient/EasyUI Sample Demo</div>
			<div class="l-topmenu-welcome">
				<font color="#ffffff">
					<span id='currentUser' class="space"></span>&nbsp; &nbsp;
					<a id="btnExport" onclick="logout('login-jclient.html')" >Exit</a>
				</font>
			</div>
		</div>
	</div>
	<div data-options="region:'west',split:true,title:'Context Menu'" style="width: 200px; padding: 10px;">
		<ul id="irtree" class="easyui-tree" style="margin-top: 3px;"></ul>
	</div>
	<div data-options="region:'center',title:'',border:false">
		<div id="tt" class="easyui-tabs" data-options="fit:true">
			<div title="首页" style="padding: 20px;">
				<h3><br></h3>
			</div>
		</div>
	</div>
	<div id="mm" class="easyui-menu" style="width:170px;">
		<div id="mm-tabclosrefresh" data-options="name:6">Reload</div>
		<div id="mm-tabclose" data-options="name:1">Close</div>
		<div id="mm-tabcloseall" data-options="name:2">Close All</div>
		<div id="mm-tabcloseother" data-options="name:3">Close Others</div>
		<div class="menu-sep"></div>
		<div id="mm-tabcloseright" data-options="name:4">Close All Right of This</div>
		<div id="mm-tabcloseleft" data-options="name:5">Close All Left of This</div>
	</div>

	<script>
		/* load menu */

		// MODIFY 2 Load menu from menu.sample (port = menu, dataset-sk = sk.menu)
		function jloadMenu() {
			var req = new jvue.DatasetCfg(	// SysMenu.java (menu.sample) uses DatasetReq as JMessage body
						jconsts.conn,		// connection id in connexts.xml
						jconsts.sk.menu);	// sk in datast.xml

			// all request are created as user reqs except query, update, insert, delete and ext like dataset.
			// user act is ignored for reading
			var jmsg = ssClient.userReq(jconsts.conn, engports.menu, req);

			// ssClient is created after logged in.
			ssClient.commit(jmsg, function(resp) {
				console.log(resp);
				// menu: resp.data.menu;
				EasyTree.bind('#irtree',	// id
						resp.data.menu, 	// data,
						'tree',				// easyui tree
						null,				// click callback
						function(node) {	// onSelect - change user act when clicked (FIXME what about tabs?)
							console.log(node);
							addTab(node);
							// index-jclient.html window is not function pages' window
							// https://stackoverflow.com/questions/4689145/pass-jquery-variables-between-iframe-and-parent
							$('iframe').get(0).contentWindow.ssClient = ssClient;
							ssClient.usrAct (node.id, node.text, node.url);
						});
				}, EasyMsger.error);
		}

		function loadUserInf(uid, onload) {
			// create a query request
			var req = ssClient.query(null, "a_user", "u", {page: 0, size: 20});
			// select userName un, userId uid, roleName role
			// from a_user u join a_roles r on u.roleId = r.roleId
			// where u.userId = 'admin'
			req.body[0]
				.expr("userName", "uname").expr("userId", "uid")
				.expr("roleName", "role").expr("u.orgId")
				.j("a_roles", "r", "u.roleId = r.roleId")
				.whereCond("=", "u.userId", "'" + uid + "'");

			// post request, handle response
			J.post(req, function(resp) {
				var users = J.respObjs(resp, 0, 1);
				onload(users[0]);
			});
		}

		/* load session info from localStorage, if failed, try cookie */
		function loadSessionInf() {
			var ssinf = localStorage.getItem(ssk);
			if (ssinf)
				return JSON.parse(ssinf);

			ssinf = $.cookie(ssk);
			if (ssinf)
				ssinf = JSON.parse(client.ssInf);
			return ssinf;
		}

		$(function() {
			// FIXME local storage is more secure, change this when only debugging online is needed.
			var ssinf = loadSessionInf();
			if (ssinf === undefined) {
				console.error('Not logged in?');
				// report error to user
				return;
			}

			ssClient = new jvue.SessionClient(ssinf.ssInf, ssinf.iv);
			var user = {};
			loadUserInf(ssinf.uid, function(usr) {
					Object.assign(user, usr);
					// uname? Because expr("userName", "uname"), see loaduserInf().
					$("#currentUser").html("欢迎您：" + user.uname);
					ssClient.userInf = user;
					jloadMenu();
				});

			$('#tt').tabs({
				fit: true,
				border: false
			});

			$('#tt').tabs({
				onContextMenu: function(e, title, index) {
					e.preventDefault();
					if(index > 0) {
						$('#mm').menu('show', {
							left: e.pageX,
							top: e.pageY
						}).data("tabTitle", title);
					}
				}
			});

			// Context Menu Click
			$("#mm").menu({
				onClick: function(item) {
					closeTab(this, item.name);
				}
			});
		});

		function addTab(node) {
			if($('#tt').tabs('exists', node.text)) {
				$('#tt').tabs('select', node.text);
			} else {
				// This is extremly wrong!
				// if(node.text == '管理系统'||node.url == ''||node.url == undefined) {} else {
				if(node.url == ''||node.url == undefined) {} else {
					$('#tt').tabs(
						'add', {
							fit: true,
							border: false,
							title: node.text,
							selected: true,
							closable: true,
							id: node.text,
							content: '<iframe scrolling="auto" frameborder="0"  src=' +
								node.url +
								' style="width:100%;height:99.5%;"></iframe>',
						});
				}
			}
		}

		function closeTab(menu, type) {
			var allTabs = $("#tt").tabs('tabs');
			var allTabtitle = [];
			$.each(allTabs, function(i, n) {
				var opt = $(n).panel('options');
				if(opt.closable)
					allTabtitle.push(opt.title);
			});
			var curTabTitle = $(menu).data("tabTitle");
			var curTabIndex = $("#tt").tabs("getTabIndex", $("#tt").tabs("getTab", curTabTitle));
			switch(type) {
				case 1:
					$("#tt").tabs("close", curTabIndex);
					return false;
					break;
				case 2:
					for(var i = 0; i < allTabtitle.length; i++) {
						$('#tt').tabs('close', allTabtitle[i]);
					}
					break;
				case 3:
					for(var i = 0; i < allTabtitle.length; i++) {
						if(curTabTitle != allTabtitle[i])
							$('#tt').tabs('close', allTabtitle[i]);
					}
					$('#tt').tabs('select', curTabTitle);
					break;
				case 4:
					for(var i = curTabIndex; i < allTabtitle.length; i++) {
						$('#tt').tabs('close', allTabtitle[i]);
					}
					$('#tt').tabs('select', curTabTitle);
					break;
				case 5:
					for(var i = 0; i < curTabIndex - 1; i++) {
						$('#tt').tabs('close', allTabtitle[i]);
					}
					$('#tt').tabs('select', curTabTitle);
					break;
				case 6: //刷新
					var panel = $("#tt").tabs("getTab", curTabTitle).panel("refresh");
					break;
			}
		}

	function logout(loginPage) {

		var header = jvue.Protocol.formatHeader(ssk);
		var body = {a:"logout"};
		 var req = new jvue.JMessage(jvue.Protocol.Port.session, header, body);
		J.post(req,function(){

			localStorage.setItem(ssk, null);
			window.location = loginPage;
		},function(){
			window.location = loginPage;
			localStorage.setItem(ssk, null);
		});
	}
	</script>
</body>

</html>

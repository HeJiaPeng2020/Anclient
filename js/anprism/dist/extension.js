(()=>{"use strict";var e={200:(e,t)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.AnprismException=void 0;class n extends Error{constructor(e){super(e),this.name="AnprismException"}getMessage(){return this.message||this.name}}t.AnprismException=n},938:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.pythonCmd=t.isLittleEndian=t.OS=t.translationsConfigFile=t.locale=t.language=t.userAgent=t.platform=t.isIOS=t.isWeb=t.isNative=t.isLinuxSnap=t.isLinux=t.isMacintosh=t.isWindows=t.platformToString=t.isElectronSandboxed=t.globals=void 0;const s=n(17),i="en";let o,r,a,l,c=!1,p=!1,h=!1,d=!1,u=!1,g=!1,m=!1,v=i;t.globals="object"==typeof self?self:"object"==typeof global?global:{},void 0!==t.globals.vscode&&void 0!==t.globals.vscode.process?l=t.globals.vscode.process:"undefined"!=typeof process&&(l=process);const w="string"==typeof l?.versions?.electron&&"renderer"===l.type;if(t.isElectronSandboxed=w&&l?.sandboxed,"object"!=typeof navigator||w)if("object"==typeof l){c="win32"===l.platform,p="darwin"===l.platform,h="linux"===l.platform,d=h&&!!l.env.SNAP&&!!l.env.SNAP_REVISION,o=i,v=i;const e=l.env.VSCODE_NLS_CONFIG;if(e)try{const t=JSON.parse(e),n=t.availableLanguages["*"];o=t.locale,v=n||i,r=t._translationsConfigFile}catch(e){}u=!0}else console.error("Unable to resolve platform.");else a=navigator.userAgent,c=a.indexOf("Windows")>=0,p=a.indexOf("Macintosh")>=0,m=(a.indexOf("Macintosh")>=0||a.indexOf("iPad")>=0||a.indexOf("iPhone")>=0)&&!!navigator.maxTouchPoints&&navigator.maxTouchPoints>0,h=a.indexOf("Linux")>=0,g=!0,o=navigator.language,v=o;t.platformToString=function(e){switch(e){case 0:return"Web";case 1:return"Mac";case 2:return"Linux";case 3:return"Windows"}};let f=0;p?f=1:c?f=3:h&&(f=2),t.isWindows=c,t.isMacintosh=p,t.isLinux=h,t.isLinuxSnap=d,t.isNative=u,t.isWeb=g,t.isIOS=m,t.platform=f,t.userAgent=a,t.language=v,t.locale=o,t.translationsConfigFile=r,t.OS=p||m?2:c?1:3;let b=!0,y=!1;t.isLittleEndian=function(){if(!y){y=!0;const e=new Uint8Array(2);e[0]=1,e[1]=2;const t=new Uint16Array(e.buffer);b=513===t[0]}return b},t.pythonCmd=function(e){let n="python3";return 1===t.OS&&(n="py"),s.join(e,n)}},624:(e,t,n)=>{Object.defineProperty(t,"__esModule",{value:!0}),t.ServHelper=void 0;const s=n(17),i=n(496),o=n(200);function r(e){const t=e.fsPath;let n=i.workspace.workspaceFolders;if(!n)throw new o.AnprismException("Why workspaceFolder is null?");return n.map((e=>e.uri.fsPath)).filter((e=>t?.startsWith(e)))[0]}t.ServHelper=class{constructor(e,t){this.serv=Object.assign({pythonPath:e.asAbsolutePath(s.join("packages","anserv.py")),starting:!1,webpackTerm:void 0},t),this.context=e}isStarting(){return this.serv.starting}starting(e){return this.serv.starting=e,this}pythonPath(){return this.serv.pythonPath}findRoot(e){const t=i.workspace.getConfiguration("launch",e)?.get("configurations");if(t)for(let n=0;n<t.length;n++)if(console.log(t[n]),"pwa-chrome"===t[n].type)return this.serv.webroot=this.resolvEnv(t[n].webRoot,{workspaceFolder:r(e)}),this;throw new o.AnprismException("Can't setup webroot. See readme for launch.json configuration.")}resolvEnv(e,t){return e.replace(/\${workspaceFolder}/g,t.workspaceFolder)}webrootPath(){return this.serv.webroot||"."}url(e){let t=s.relative(this.webrootPath(),e.html.fsPath),n=s.basename(t,".html");const i=`http://${e.host}:${e.port}/${function(){let e="";const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";for(let n=0;n<32;n++)e+=t.charAt(Math.floor(Math.random()*t.length));return e}()}.html?nonce=${n}`;return console.log(i),{url:i,sub:t}}checkHtml(e){if(this.serv.webroot){const t=s.relative(this.serv.webroot,e.fsPath);if(!t||t.startsWith("..")||s.isAbsolute(t))throw new o.AnprismException("page is not located in root folder: "+e.fsPath)}else this.findRoot(e);return this}update(e){e?.webroot?.length&&this.findRoot(i.Uri.file(e.webroot))}}},496:e=>{e.exports=require("vscode")},81:e=>{e.exports=require("child_process")},17:e=>{e.exports=require("path")}},t={};function n(s){var i=t[s];if(void 0!==i)return i.exports;var o=t[s]={exports:{}};return e[s](o,o.exports,n),o.exports}var s={};(()=>{var e=s;Object.defineProperty(e,"__esModule",{value:!0}),e.deactivate=e.activate=void 0;const t=n(496),i=n(81),o=n(17),r=n(938),a=n(624),l=n(200);e.activate=function(e){c.log||(c.log=t.window.createOutputChannel("Anprism")),c.log.appendLine("Starting Anprism ..."),e.subscriptions.push(t.commands.registerCommand("anprism.load",((t,n)=>{c.load(e,t)}))),e.subscriptions.push(t.commands.registerCommand("anprism.refresh",(()=>{c.currentPanel&&c.currentPanel.refresh(void 0)}))),e.subscriptions.push(t.commands.registerCommand("anprism.restartServer",(()=>{c.currentPanel?c.currentPanel.startup():t.window.showInformationMessage("Sorry! Currently sever can only be started when Anprism loading a page!")}))),e.subscriptions.push(t.commands.registerCommand("anprism.shutdownServer",(()=>{c.currentPanel?c.currentPanel.close():t.window.showInformationMessage("Currently Anprism server can only be shutdown via web page view!")})))},e.deactivate=function(){c.currentPanel&&c.currentPanel.close()};class c{constructor(e,n,s){this._disposables=[],this.page={port:"8888",host:"localhost",html:t.Uri.file("index.html"),style:"background-color: #ccc",reload:!1,devtool:!1},this.serv=s,this._panel=n,c._extensionUri=e.extensionUri,this._panel.onDidDispose((()=>this.dispose()),null,this._disposables),this._panel.onDidChangeViewState((e=>{this._panel.visible&&this.page.reload?(this.page.reload=!1,this.refresh(void 0)):this._panel.visible||(this.page.reload=!0)}),this,this._disposables),this._panel.webview.onDidReceiveMessage((e=>{"alert"!==e.command||t.window.showErrorMessage(e.text)}),null,this._disposables)}handleWebviewMessage(e){if("devtools-open"===e.command)return t.commands.executeCommand("workbench.action.webview.openDeveloperTools",c.currentPanel?.page.devtool),void(c.currentPanel.page.devtool=!c.currentPanel?.page.devtool)}static async load(e,n){let s=c.currentPanel;const i=t.window.activeTextEditor?t.window.activeTextEditor.viewColumn:void 0;if(!s)try{const o=t.window.createWebviewPanel(c.viewType,`Anprism - ${c.filename(n)}`,i||t.ViewColumn.One,{enableScripts:!0});o.webview.options={enableScripts:!0},c.log.appendLine("Open page "+c.filename(n)),s=new c(e,o,new a.ServHelper(e).findRoot(n))}catch(e){if(e instanceof l.AnprismException)return void t.window.showErrorMessage(e.getMessage())}if(s=s,c.currentPanel=s,s._panel.webview.onDidReceiveMessage((e=>c.currentPanel.handleWebviewMessage(e))),!s.serv.isStarting())try{await s.startup()}catch(e){e instanceof l.AnprismException&&t.window.showInformationMessage(e.getMessage()||"")}try{s.refresh(n)}catch(e){e instanceof l.AnprismException&&t.window.showErrorMessage(e.getMessage())}s._panel.reveal(i)}async startup(){const e=`${(0,r.pythonCmd)("")} ${this.serv.pythonPath()} -b 0.0.0.0 -w ${this.serv.webrootPath()} ${this.page.port} &`;this.serv.starting(!0),c.log.appendLine(e),t.window.showInformationMessage("Starting Anprism server at "+this.serv.webrootPath()),new Promise(((n,s)=>{i.exec(e,((e,i)=>e?(this.serv.starting(!1),c.log.appendLine(e.message),t.window.showInformationMessage("Starting Anprism server failed. "+e.message),s(e)):(c.log.appendLine(i.toString()),n(i))))}))}dispose(){for(c.currentPanel=void 0,this._panel.dispose();this._disposables.length;){const e=this._disposables.pop();e&&e.dispose()}}refresh(e){this._panel.webview.html="",this.page.html=e||this.page.html,this.serv.checkHtml(this.page.html),this._panel.webview.html=this.getAnclientPage(this.page)}getAnclientPage(e){let{url:t,sub:n}=this.serv.url(e);return c.log.appendLine(t),`<!DOCTYPE html>\n\t\t<html lang="en">\n\t\t<head>\n\t\t\t<meta charset="UTF-8">\n\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t\t\t<script type="text/javascript">var vscode = acquireVsCodeApi();<\/script>\n\t\t</head>\n\t\t<body>\n\t\t\t<p id="lines-of-code-counter">${n}\n\t\t\t<input type='button' value='refresh' onclick='console.log("refresh"); document.getElementById("i-anprism").src = document.getElementById("i-anprism").src'\n\t\t\t/>\n\t\t\t<input type='button' value='dev tool'\n\t\t\t\tonclick='vscode.postMessage({ command: "devtools-open", text: "" });'\n\t\t\t/>\n\t\t\t</p>\n\t\t\t<iframe id='i-anprism' src="${t}" width="100%" height="720px" style="${e.style}" ></iframe>\n\t\t\t<script type="text/javascript">\n\t\t\t\tconsole.log("iframe.src", document.getElementById("i-anprism").getAttribute("src"));\n\t\t\t<\/script>\n\t\t</body>\n\t\t</html>`}close(){c.log.appendLine("Shuting down: "+this.serv?.serv.webroot),t.window.showInformationMessage("Shuting down Anprism server.");const e=`http://${this.page.host}:${this.page.port}?_shut-down_=True`;console.log(e),this._panel.webview.html="",this.serv.starting(!1),this._panel.webview.html=`<!DOCTYPE html>\n\t\t<html lang="en">\n\t\t<head>\n\t\t\t<meta charset="UTF-8">\n\t\t\t<meta name="viewport" content="width=device-width, initial-scale=1.0">\n\t\t</head>\n\t\t<body>\n\t\t\t<iframe id="i-anprism" src="${e}" width="100%" height="720px" style="${this.page.style}" ></iframe>\n\t\t\t<script type="text/javascript">\n\t\t\t\tconsole.log("iframe.src", document.getElementById("i-anprism").getAttribute("src"));\n\t\t\t<\/script>\n\t\t</body>\n\t\t</html>`}static filename(e){return o.basename(e.path)}}c.viewType="anprism"})(),module.exports=s})();